code: cdp_kc_auth
guiCode: "<#assign wp=JspTaglibs[\"/aps-core\"]>\r\n<script nonce=\"<@wp.cspNonce />\" >\r\n  (function () {\r\n    const consolePrefix = '[ENTANDO-KEYCLOAK]';\r\n    const entPath= location.protocol + '//' + location.host;\r\n    const keycloakConfigEndpoint = entPath+ '/entando-de-app/keycloak.json';\r\n\r\n    let keycloakConfig;\r\n    function dispatchKeycloakEvent(eventType) {\r\n      console.info(consolePrefix, 'Dispatching', eventType, 'custom event');\r\n      return window.dispatchEvent(new CustomEvent('keycloak', { detail: { eventType } }));\r\n    };\r\n    function initKeycloak() {\r\n      const keycloak = new Keycloak(keycloakConfig);\r\n      keycloak.onReady = function() {\r\n        dispatchKeycloakEvent('onReady');\r\n      };\r\n      keycloak.onAuthSuccess = function() {\r\n        dispatchKeycloakEvent('onAuthSuccess');\r\n      };\r\n      keycloak.onAuthError = function() {\r\n        dispatchKeycloakEvent('onAuthError');\r\n      };\r\n      keycloak.onAuthRefreshSuccess = function() {\r\n        dispatchKeycloakEvent('onAuthRefreshSuccess');\r\n      };\r\n      keycloak.onAuthRefreshError = function() {\r\n        dispatchKeycloakEvent('onAuthRefreshError');\r\n      };\r\n      keycloak.onAuthLogout = function() {\r\n        dispatchKeycloakEvent('onAuthLogout');\r\n      };\r\n      keycloak.onTokenExpired = function() {\r\n        dispatchKeycloakEvent('onTokenExpired');\r\n      };\r\n      function onKeycloakInitialized(isAuthenticated) {\r\n        if (isAuthenticated) {\r\n          console.info(consolePrefix, 'Keycloak initialized, user authenticated');\r\n        } else {\r\n          console.info(consolePrefix, 'Keycloak initialized, user not authenticated');\r\n        }\r\n      };\r\n      window.entando = {\r\n        ...(window.entando || {}),\r\n        keycloak,\r\n      };\r\n      window.entando.keycloak\r\n        .init({ \r\n        onLoad: 'check-sso',\r\n         silentCheckSsoRedirectUri: '<@wp.info key=\"systemParam\" paramName=\"applicationBaseURL\" />cmsresources/bundles/case-management-bundle-29795610/resources/silent-check-sso.html',\r\n        promiseType: 'native', \r\n        enableLogging: true \r\n        })\r\n        .then(onKeycloakInitialized)\r\n        .catch(function (e) {\r\n          console.error(e);\r\n          console.error(consolePrefix, 'Failed to initialize Keycloak');\r\n        });\r\n    };\r\n    function onKeycloakScriptError(e) {\r\n      console.error(e);\r\n      console.error(consolePrefix, 'Failed to load keycloak.js script');\r\n    };\r\n    function addKeycloakScript(keycloakConfig) {\r\n      const script = document.createElement('script');\r\n      script.src = keycloakConfig['auth-server-url'] + '/js/keycloak.js';\r\n      script.async = true;\r\n      script.addEventListener('load', initKeycloak);\r\n      script.addEventListener('error', onKeycloakScriptError);\r\n      document.body.appendChild(script);\r\n    };\r\n    fetch(keycloakConfigEndpoint)\r\n      .then(function (response) {\r\n        return response.json();\r\n      })\r\n      .then(function (config) {\r\n        keycloakConfig = config;\r\n        if (!keycloakConfig.clientId) {\r\n          keycloakConfig.clientId = keycloakConfig.resource;\r\n        }\r\n        addKeycloakScript(keycloakConfig);\r\n      })\r\n      .catch(function (e) {\r\n        console.error(e);\r\n        console.error(consolePrefix, 'Failed to fetch Keycloak configuration');\r\n      });\r\n  })();</script>"
